# This is a conf file to use for a reverse proxy on Apache2 back to your Guacamole server so it can be accessed from the internet.
# Your Guacamole server should already be functional and accessible via http://192.168.1.243:8080
# You need to install these modules in your Apache2 server: proxy, proxy_http, proxy_wstunnel, ssl, rewrite, headers
# You need a public DNS entry guac.yourdomain.com pointing to your fixed IP address, ports 80 and 443 forwarded on your router to your Apache2 server.
# First create the LetsEncrypt Certbot certiticate with: certbot certonly --webroot -w /var/www/html -d guac.yourdomain.com
# Certificates will be created in /etc/letsencrypt/live/guac.yourdomain.com/
# Then enable your site: a2ensite guac.yourdomain.com.conf
# Run systemctl reload apache2
# Test https://guac.yourdomain.com (from the LAN and from the Internet). Enjoy!
#

<VirtualHost *:443>
	ServerName guac.yourdomain.com

	# --- TLS ---
	SSLEngine on
	SSLCertificateFile /etc/letsencrypt/live/guac.yourdomain.com/fullchain.pem
	SSLCertificateKeyFile /etc/letsencrypt/live/guac.yourdomain.com/privkey.pem

	# (Optional) modern TLS policy â€” adapt to your org baselines
	SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
	SSLCipherSuite HIGH:!aNULL:!MD5
	SSLHonorCipherOrder on

	# --- Logging ---
	ErrorLog ${APACHE_LOG_DIR}/guacamole-error.log
	CustomLog ${APACHE_LOG_DIR}/guacamole-access.log combined

	# --- Forward scheme header for Tomcat's RemoteIpValve ---
	# Apache provides X-Forwarded-For automatically; we add X-Forwarded-Proto.
	# RequestHeader set X-Forwarded-Proto "https"

	# --- Guacamole HTTP app at root (include flushpackets=on) ---
	<Location />
		Order allow,deny
		Allow from all
		ProxyPass        http://192.168.1.243:8080/ flushpackets=on
		ProxyPassReverse http://192.168.1.243:8080/
	</Location>

	# --- Guacamole WebSocket tunnel (place AFTER the root Location) ---
	<Location /websocket-tunnel>
		Order allow,deny
		Allow from all
		ProxyPass        ws://192.168.1.243:8080/websocket-tunnel
		ProxyPassReverse ws://192.168.1.243:8080/websocket-tunnel
	</Location>

	# (Optional) reduce noisy HTTP-tunnel logs when WebSocket is unavailable
	# SetEnvIf Request_URI "^/tunnel" dontlog
	# CustomLog /var/log/apache2/guac.log common env=!dontlog

	# (Optional) if your backend is slow
	ProxyTimeout 300
</VirtualHost>
